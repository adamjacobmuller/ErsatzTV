name: Sync Fork with Upstream

on:
  schedule:
    # Run every Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: git remote add upstream https://github.com/ErsatzTV/ErsatzTV.git

      - name: Fetch upstream
        run: git fetch upstream

      - name: Check for upstream changes
        id: check
        run: |
          BEHIND=$(git rev-list --count HEAD..upstream/main)
          echo "behind=$BEHIND" >> $GITHUB_OUTPUT
          if [ "$BEHIND" -eq 0 ]; then
            echo "Already up to date with upstream"
          else
            echo "Fork is $BEHIND commits behind upstream"
          fi

      - name: Attempt rebase
        id: rebase
        if: steps.check.outputs.behind != '0'
        run: |
          if git rebase upstream/main; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "Rebase successful"
          else
            git rebase --abort
            echo "success=false" >> $GITHUB_OUTPUT
            echo "Rebase failed - conflicts detected"
          fi

      - name: Push changes
        if: steps.check.outputs.behind != '0' && steps.rebase.outputs.success == 'true'
        run: git push --force-with-lease origin main

      - name: Trigger build
        if: steps.check.outputs.behind != '0' && steps.rebase.outputs.success == 'true'
        run: gh workflow run Build --ref main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create issue on conflict
        if: steps.check.outputs.behind != '0' && steps.rebase.outputs.success == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Upstream sync failed - manual rebase required';
            const body = `The automated sync with upstream ErsatzTV/ErsatzTV failed due to merge conflicts.

            **Commits behind upstream:** ${{ steps.check.outputs.behind }}

            Please manually rebase:
            \`\`\`bash
            git fetch origin
            git fetch upstream  # or: git remote add upstream https://github.com/ErsatzTV/ErsatzTV.git && git fetch upstream
            git checkout main
            git rebase upstream/main
            # resolve conflicts
            git push --force-with-lease origin main
            \`\`\`

            [Compare with upstream](https://github.com/ErsatzTV/ErsatzTV/compare/main...adamjacobmuller:ErsatzTV:main)`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['upstream-sync']
              });
            }
